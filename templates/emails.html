<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°è¦‹ç©ã‚‚ã‚Šç®¡ç†</title>
<style>
/*â”€â”€ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
body{display:flex;height:100vh;margin:0;font-family:Arial,Helvetica,sans-serif}
#sidebar{width:380px;min-width:320px;border-right:1px solid #ccc;overflow:auto}
#detail{flex:1;overflow:auto;padding:16px}

/*â”€â”€ ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #ddd;padding:6px;font-size:.9rem}
th{background:#f0f0f0;position:sticky;top:0}
tr:hover{outline:2px solid #4285f4;cursor:pointer}
tr.selected{outline:2px solid #4285f4}
.st-new{background:#ff6666}.st-sent{background:#e5ffe5}
.st-req{background:#e6f2ff}.st-in{background:#fff7cc}.st-out{background:#fff}
.arch{background:#f5f5f5!important;color:#999}
.ellipsis{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px}

/*â”€â”€ è©³ç´°ãƒ“ãƒ¥ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
.inline-wrap{display:inline-block;width:23%;min-width:140px;margin:4px;vertical-align:top;position:relative}
.inline-thumb{width:100%;height:auto;border:1px solid #ccc}
.dl-link{display:none;position:absolute;right:4px;bottom:4px;background:rgba(0,0,0,.6);color:#fff;font-size:12px;padding:2px 4px;border-radius:3px;text-decoration:none}
.inline-wrap:hover .dl-link{display:block}
.photos{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.photos a{flex:0 0 calc(25% - 8px);min-width:150px}
.photos img{width:100%;height:auto;border:1px solid #ccc}
textarea{width:100%;min-height:110px;font-family:monospace;font-size:.9rem;padding:6px}
.note-block{margin-bottom:10px;border:1px solid #ddd;padding:4px;border-radius:4px}
.note-block h4{margin:2px 0 6px;font-size:.9rem}

/*â”€â”€ ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
#img-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);justify-content:center;align-items:center;z-index:999}
#img-modal img{max-width:90%;max-height:90%}
#img-dl{position:absolute;top:18px;right:30px;font-size:1.3rem;color:#fff;text-decoration:none}

/*â”€â”€ æ‰‹å‹•ç™»éŒ²ãƒ€ã‚¤ã‚¢ãƒ­ã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
#addDlg{display:none;position:fixed;inset:0;justify-content:center;align-items:center;background:rgba(0,0,0,.5);z-index:1000}
#addDlg form{background:#fff;padding:18px 20px;border-radius:8px;width:340px;box-shadow:0 4px 12px rgba(0,0,0,.25)}
#addDlg input[type=text]{width:100%;padding:6px;margin-bottom:8px}
#addDlg textarea{height:120px;width:100%;padding:6px}
</style>
</head>
<body>

<!--â”€â”€â”€â”€â”€â”€â”€â”€ å·¦ãƒšã‚¤ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-->
<div id="sidebar">
  <div style="padding:8px;border-bottom:1px solid #ccc;background:#fafafa;display:flex;gap:6px;align-items:center">
    <button id="syncBtn">ä»Šã™ãå–ã‚Šè¾¼ã‚€</button>
    <button id="addBtn">ï¼‹æ‰‹å‹•ç™»éŒ²</button>
    <button id="archToggle" title="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–è¡¨ç¤ºåˆ‡æ›¿">ğŸŒ“</button>
    <input id="nameFilter" placeholder="é¡§å®¢åæ¤œç´¢" style="flex:1;min-width:0;font-size:.85rem;padding:4px">
    <span id="syncMsg" style="font-size:.8rem;color:#555"></span>
  </div>

  <table>
    <thead><tr><th>UID</th><th>ä»¶å</th><th>é¡§å®¢å</th></tr></thead>
    <tbody id="list">
      {% for m in emails %}
      <tr data-uv="{{m.uidvalidity}}" data-uid="{{m.uid}}" data-arch="{{1 if m.archived else 0}}"
          class="{{'arch ' if m.archived else ''}}st-{{
            'new' if m.status=='æœªå¯¾å¿œ' else
            'sent' if m.status=='è¦‹ç©ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ¸ˆ' else
            'req' if m.status=='ä¾é ¼ã‚ã‚Š' else
            'in' if m.status=='è·ç‰©å—ã‘å–ã‚Š' else 'out'}}">
        <td>{{m.uid}}</td>
        <td class="ellipsis" title="{{m.subject}}">{{m.subject}}</td>
        <td class="ellipsis cust" title="{{m.customer_name}}">{{m.customer_name}}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!--â”€â”€â”€â”€â”€â”€â”€â”€ å³ãƒšã‚¤ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-->
<div id="detail"><p>å·¦ã®ãƒ¡ãƒ¼ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p></div>

<!-- ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="img-modal"><a id="img-dl" download>â†“ä¿å­˜</a><img id="img-view"></div>

<!-- æ‰‹å‹•ç™»éŒ²ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="addDlg">
  <form id="addForm" enctype="multipart/form-data">
    <h3>æ‰‹å‹•ç™»éŒ²</h3>
    <input type="text" name="name" placeholder="é¡§å®¢å (å¿…é ˆ)" required>
    <textarea name="memo" placeholder="ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ (ç©ºã§ã‚‚å¯)"></textarea>
    <input type="file" name="photos" accept="image/*" multiple style="margin:6px 0">
    <div style="text-align:right;margin-top:6px">
      <button type="button" id="addCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button type="submit">ç™»éŒ²</button>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

/* è¦ç´ å‚ç…§ */
const list=document.getElementById('list'), detail=document.getElementById('detail');
const modal=document.getElementById('img-modal'), filter=document.getElementById('nameFilter');
const archToggle=document.getElementById('archToggle'); let showArch=false, curRow=null;

/* ES ä¾¿åˆ©é–¢æ•° */
const esc=s=>String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));

/* ä¸€è¦§ãƒ•ã‚£ãƒ«ã‚¿ */
function applyFilter(){
  const q=filter.value.trim(), reg=new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i');
  list.querySelectorAll('tr').forEach(tr=>{
    const name=tr.querySelector('.cust').textContent, isArch=tr.dataset.arch==='1';
    const show=q===''? (showArch||!isArch) : reg.test(name);
    tr.style.display=show?'':'none';
  });
  if(curRow&&curRow.style.display==='none'){ detail.innerHTML='<p>å·¦ã®ãƒ¡ãƒ¼ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>'; curRow=null; }
}
filter.oninput=applyFilter;
archToggle.onclick=()=>{ showArch=!showArch; archToggle.textContent=showArch?'ğŸŒ•':'ğŸŒ“'; applyFilter(); };

/* æ‰‹å‹•ç™»éŒ²ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
const dlg=document.getElementById('addDlg'), form=dlg.querySelector('#addForm');
document.getElementById('addBtn').onclick=()=>{ form.reset(); dlg.style.display='flex'; };
document.getElementById('addCancel').onclick=()=>{ dlg.style.display='none'; };
form.onsubmit=async e=>{
  e.preventDefault();
  const fd=new FormData(form);
  const r=await fetch('/manual_add',{method:'POST',body:fd});
  if(r.ok){ alert('ç™»éŒ²ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¾ã™'); location.reload(); }
  else{ alert('å¤±æ•—: '+(await r.text())); }
};

/* åŒæœŸ */
const syncBtn=document.getElementById('syncBtn'), syncMsg=document.getElementById('syncMsg');
syncBtn.onclick=async ()=>{
  syncBtn.disabled=true; syncMsg.textContent='åŒæœŸä¸­â€¦';
  try{const j=await (await fetch('/sync_now',{method:'POST'})).json();
      syncMsg.textContent=j.ok?'å®Œäº†ã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„':`å¤±æ•—:${j.error}`;}
  catch{syncMsg.textContent='é€šä¿¡ã‚¨ãƒ©ãƒ¼';}
  syncBtn.disabled=false;
};

/* æœ¬æ–‡æ•´å½¢ï¼ˆç”»åƒã‚µãƒ ãƒï¼‰ */
function fmtBody(txt){
  const seen=new Set();
  let s=esc(txt);
  s=s.replace(/(?:&lt;|\[)?\s*(https?:\/\/[^\s"'<>]+\.(?:png|jpe?g|gif))\s*(?:\]|&gt;)?/gi,
    (_,u)=>{if(seen.has(u))return'';seen.add(u);const enc=encodeURIComponent(u);
      return `<span class="inline-wrap"><img class="inline-thumb" src="/proxy?url=${enc}">
              <a class="dl-link" href="/proxy?url=${enc}" download>DL</a></span>`});
  s=s.replace(/(https?:\/\/[^\s"'<>]+)/gi,'<a target="_blank" href="$1">$1</a>');
  return s.replace(/\n/g,'<br>');
}

/* è©³ç´°è¡¨ç¤º */
list.onclick=e=>{const tr=e.target.closest('tr'); if(tr) show(tr.dataset.uv,tr.dataset.uid,tr);};

async function show(uv,uid,tr){
  if(curRow)curRow.classList.remove('selected'); tr.classList.add('selected'); curRow=tr;
  const d=await (await fetch(`/email/${uv}/${uid}`)).json();

  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚©ãƒ¼ãƒ  */
  const statusSel=['æœªå¯¾å¿œ','è¦‹ç©ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ¸ˆ','ä¾é ¼ã‚ã‚Š','è·ç‰©å—ã‘å–ã‚Š','è·ç‰©è¿”é€æ¸ˆã¿']
    .map(s=>`<option${s===d.status?' selected':''}>${s}</option>`).join('');

  /* æ—¢å­˜ãƒ¡ãƒ¢ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ */
  const notes=d.notes||{}, noteIds=Object.keys(notes).map(n=>+n);
  let maxPage=noteIds.length?Math.max(...noteIds):1;

  /* ãƒ¡ãƒ¢ HTML ç”Ÿæˆ */
  const noteHtml=p=>`<div class="note-block" data-p="${p}">
      <h4>P${p}</h4>
      <textarea>${esc(notes[p]??'')}</textarea>
      <button class="saveBtn">ä¿å­˜</button>
    </div>`;

  detail.innerHTML=`
    <h2>${esc(d.subject)}</h2>
    <div style="margin-bottom:6px">
      <b>UID:</b>${d.uid} / <b>é¡§å®¢å:</b>${esc(d.customer_name)}
      <button id="archBtn">${d.archived?'æˆ»ã™':'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–'}</button>
    </div>

    <form id="stf" style="margin:6px 0">
      <select name="status">${statusSel}</select>
      <button>æ›´æ–°</button>
    </form>

    <div>${fmtBody(d.body)}</div>

    <h3>ãƒ•ãƒªãƒ¼ãƒ¡ãƒ¢ <button id="addNote">ï¼‹ãƒ¡ãƒ¢è¿½åŠ </button></h3>
    <div id="notes">
      ${noteHtml(1)}
      ${noteIds.filter(n=>n>1).sort((a,b)=>a-b).map(noteHtml).join('')}
    </div>

    <h3>å†™çœŸ</h3>
    <div class="photos">${d.photos.map(u=>`<a href="${u}" target="_blank"><img src="${u}"></a>`).join('')}</div>
    <form id="pf" enctype="multipart/form-data" style="margin-top:6px">
      <input type="file" name="photo" accept="image/*">
      <button>Upload</button>
    </form>`;

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° */
document.getElementById('stf').onsubmit = e =>{
  e.preventDefault();
  const fd   = new FormData(e.target);
  const newSt= fd.get('status');


   fetch(`/emails/${uv}/${uid}/update_status`,{method:'POST',body:fd})
     .then(res=>{
       if(!res.ok){ alert('ä¿å­˜å¤±æ•—'); return; }   // â† å¤±æ•—ãªã‚‰è­¦å‘Š
       tr.className = (tr.className.replace(/st-\w+/,'')+' '+statusClass(newSt)).trim();
       return show(uv,uid,tr);                     // â† ã“ã“ã§æœ€æ–°å€¤ã‚’å†å–å¾—
     });
};


  const statusClass=s=>s==='æœªå¯¾å¿œ'?'st-new':s==='è¦‹ç©ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ¸ˆ'?'st-sent':s==='ä¾é ¼ã‚ã‚Š'?'st-req':s==='è·ç‰©å—ã‘å–ã‚Š'?'st-in':'st-out';

  /* ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–åˆ‡æ›¿ */
  document.getElementById('archBtn').onclick=async ()=>{
    const j=await (await fetch(`/emails/${uv}/${uid}/toggle_archive`,{method:'POST'})).json();
    tr.dataset.arch=j.archived?'1':'0'; tr.classList.toggle('arch',j.archived);
    applyFilter(); document.getElementById('archBtn').textContent=j.archived?'æˆ»ã™':'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–';
  };

  /* ãƒ¡ãƒ¢ä¿å­˜ */
  detail.querySelectorAll('.note-block .saveBtn').forEach(btn=>{
    btn.onclick=()=>saveNote(btn.closest('.note-block').dataset.p);
  });
  function saveNote(p){
    const v=detail.querySelector(`.note-block[data-p="${p}"] textarea`).value;
    const fd=new FormData(); fd.append('page',p); fd.append('content',v);
    fetch(`/emails/${uv}/${uid}/save_note`,{method:'POST',body:fd});
  }

  /* ãƒ¡ãƒ¢è¿½åŠ  */
  document.getElementById('addNote').onclick=()=>{
    maxPage++; const notesDiv=document.getElementById('notes');
    notesDiv.insertAdjacentHTML('beforeend',noteHtml(maxPage));
    notesDiv.querySelector(`.note-block[data-p="${maxPage}"] .saveBtn`)
      .onclick=()=>saveNote(maxPage);
  };

  /* å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
  document.getElementById('pf').onsubmit=e=>{
    e.preventDefault();
    fetch(`/emails/${uv}/${uid}/upload_photo`,{method:'POST',body:new FormData(e.target)})
      .then(()=>show(uv,uid,tr));   // å†æç”»
  };

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  detail.querySelectorAll('.photos img').forEach(img=>{
    img.onclick=ev=>{ev.preventDefault();
      document.getElementById('img-view').src=img.parentNode.href;
      document.getElementById('img-dl').href=img.parentNode.href;
      modal.style.display='flex';};
  });
}
/* ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ */
modal.onclick=e=>{if(e.target===modal) modal.style.display='none';};
});
</script>
</body>
</html>
